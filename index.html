<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êñá‰ª∂ÂõæÁâáÊèêÂèñÂ∑•ÂÖ∑</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            background: #fff;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .header p {
            font-size: 1rem;
            color: #666;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background: #f0f4ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #007bff;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: #666;
            font-size: 0.9rem;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .file-size {
            color: #666;
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .upload-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-top: 15px;
        }

        .upload-btn:hover {
            background: #0056b3;
        }

        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-section {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .results-title {
            font-size: 1.3rem;
            color: #333;
            font-weight: 500;
        }

        .results-count {
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-card {
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .image-card:hover {
            transform: translateY(-2px);
        }

        .image-preview {
            width: 100%;
            height: 150px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
        }

        .image-info {
            padding: 12px;
        }

        .image-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .image-details {
            color: #666;
            font-size: 0.8rem;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            border: 1px solid #c3e6cb;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .refresh-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s ease;
        }

        .refresh-btn:hover {
            background: #545b62;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 6px;
            }

            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .content {
                padding: 20px;
            }

            .images-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Êñá‰ª∂ÂõæÁâáÊèêÂèñÂ∑•ÂÖ∑</h1>
            <p>‰∏ä‰º†PDFÊàñWordÊñáÊ°£ÔºåËá™Âä®ÊèêÂèñÂÖ∂‰∏≠ÁöÑÂõæÁâá</p>

        </div>
        <div class="content">
            <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">ÁÇπÂáªÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ</div>
                    <div class="upload-hint">ÊîØÊåÅ PDF„ÄÅDOC„ÄÅDOCX Ê†ºÂºè</div>
                </div>
                <input type="file" id="fileInput" accept=".pdf,.doc,.docx">

                <div class="file-info" id="fileInfo">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-size" id="fileSize"></div>
                </div>

                <div class="upload-btn" id="uploadBtn">
                    ÂºÄÂßãÊèêÂèñÂõæÁâá
                </div>
            </div>

            <!-- ËøõÂ∫¶Êù° -->
            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Ê≠£Âú®Â§ÑÁêÜÊñá‰ª∂...</div>
            </div>

            <!-- ÈîôËØØ‰ø°ÊÅØ -->
            <div class="error-message" id="errorMessage"></div>

            <!-- ÊàêÂäü‰ø°ÊÅØ -->
            <div class="success-message" id="successMessage"></div>

            <!-- ÁªìÊûúÂ±ïÁ§∫ -->
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <div class="results-title">ÊèêÂèñÁªìÊûú</div>
                    <div class="results-hint">ÂõæÁâá‰ª•base64Ê†ºÂºèËøîÂõûÔºåÊó†ÈúÄÂà∑Êñ∞</div>
                </div>
                <div class="images-grid" id="imagesGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // APIÂü∫Á°ÄURL
        const API_BASE_URL = 'http://localhost:3020';

        // DOMÂÖÉÁ¥†
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const resultsSection = document.getElementById('resultsSection');
        const imagesGrid = document.getElementById('imagesGrid');

        // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊñá‰ª∂
        let selectedFile = null;

        // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨
        function initializeEventListeners() {
            // ÁÇπÂáª‰∏ä‰º†Âå∫Âüü
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // Êñá‰ª∂ÈÄâÊã©
            fileInput.addEventListener('change', handleFileSelect);

            // ÊãñÊãΩ‰∫ã‰ª∂
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);

            // ‰∏ä‰º†ÊåâÈíÆ
            uploadBtn.addEventListener('click', handleUpload);
        }

        // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processSelectedFile(file);
            }
        }

        // Â§ÑÁêÜÊãñÊãΩÊÇ¨ÂÅú
        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        // Â§ÑÁêÜÊãñÊãΩÁ¶ªÂºÄ
        function handleDragLeave(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        // Â§ÑÁêÜÊñá‰ª∂ÊãñÊãΩ
        function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processSelectedFile(files[0]);
            }
        }

        // Â§ÑÁêÜÈÄâ‰∏≠ÁöÑÊñá‰ª∂
        function processSelectedFile(file) {
            // È™åËØÅÊñá‰ª∂Á±ªÂûã
            const allowedTypes = ['.pdf', '.doc', '.docx'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

            if (!allowedTypes.includes(fileExtension)) {
                showError('‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè„ÄÇÂè™ÊîØÊåÅ PDF Âíå Word ÊñáÊ°£„ÄÇ');
                return;
            }

            // È™åËØÅÊñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫50MBÔºâ
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showError('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá50MB„ÄÇ');
                return;
            }

            selectedFile = file;

            // ÊòæÁ§∫Êñá‰ª∂‰ø°ÊÅØ
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');

            // ÂêØÁî®‰∏ä‰º†ÊåâÈíÆ
            uploadBtn.disabled = false;

            // ÈöêËóè‰πãÂâçÁöÑÊ∂àÊÅØ
            hideMessages();
        }

        // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
        async function handleUpload() {
            if (!selectedFile) {
                showError('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂');
                return;
            }

            // ÊòæÁ§∫ËøõÂ∫¶Êù°
            showProgress();
            hideMessages();

            try {
                console.log('ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂:', selectedFile.name, 'Â§ßÂ∞è:', selectedFile.size);

                const formData = new FormData();
                formData.append('file', selectedFile);

                // Ê®°ÊãüËøõÂ∫¶Êõ¥Êñ∞
                const progressInterval = setInterval(() => {
                    const currentProgress = parseInt(progressFill.style.width) || 0;
                    if (currentProgress < 90) {
                        progressFill.style.width = (currentProgress + 10) + '%';
                    }
                }, 500);

                console.log('ÂèëÈÄÅËØ∑Ê±ÇÂà∞:', `${API_BASE_URL}/extract-images`);

                // ÂèëÈÄÅËØ∑Ê±Ç
                const response = await fetch(`${API_BASE_URL}/extract-images`, {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressText.textContent = 'Â§ÑÁêÜÂÆåÊàêÔºÅ';

                console.log('ÊúçÂä°Âô®ÂìçÂ∫îÁä∂ÊÄÅ:', response.status, response.statusText);

                if (!response.ok) {
                    let errorMessage = '‰∏ä‰º†Â§±Ë¥•';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('ÊúçÂä°Âô®ËøîÂõûÁªìÊûú:', result);

                if (result.success) {
                    showSuccess(`ÊàêÂäüÊèêÂèñ ${result.data.totalImages} Âº†ÂõæÁâá`);
                    // Áõ¥Êé•ÊòæÁ§∫ÊèêÂèñÁöÑÂõæÁâáÔºåËÄå‰∏çÊòØÂä†ËΩΩÂõæÁâáÂàóË°®
                    if (result.data.images && result.data.images.length > 0) {
                        displayImages(result.data.images);
                        resultsSection.style.display = 'block';
                    } else {
                        resultsSection.style.display = 'none';
                    }
                } else {
                    throw new Error(result.message || 'Â§ÑÁêÜÂ§±Ë¥•');
                }

            } catch (error) {
                console.error('‰∏ä‰º†Â§±Ë¥•:', error);
                showError(`‰∏ä‰º†Â§±Ë¥•: ${error.message}`);
            } finally {
                // ÈöêËóèËøõÂ∫¶Êù°
                setTimeout(() => {
                    hideProgress();
                }, 2000);
            }
        }

        // Âä†ËΩΩÂõæÁâáÂàóË°®
        async function loadImages() {
            try {
                const response = await fetch(`${API_BASE_URL}/images`);

                if (!response.ok) {
                    throw new Error('Ëé∑ÂèñÂõæÁâáÂàóË°®Â§±Ë¥•');
                }

                const result = await response.json();

                if (result.success && result.data.images.length > 0) {
                    displayImages(result.data.images);
                    resultsSection.style.display = 'block';
                } else {
                    resultsSection.style.display = 'none';
                }

            } catch (error) {
                console.error('Âä†ËΩΩÂõæÁâáÂ§±Ë¥•:', error);
                showError('Âä†ËΩΩÂõæÁâáÂàóË°®Â§±Ë¥•');
            }
        }

        // ÊòæÁ§∫ÂõæÁâáÂàóË°®
        function displayImages(images) {
            imagesGrid.innerHTML = '';

            images.forEach(image => {
                const imageCard = document.createElement('div');
                imageCard.className = 'image-card';

                const isImageFile = ['JPG', 'JPEG', 'PNG', 'GIF', 'BMP', 'WEBP'].includes(image.format);

                // Ê£ÄÊü•ÂõæÁâáÂú∞ÂùÄÊòØÂê¶‰∏∫base64Ê†ºÂºè
                const isBase64 = image.imageUrl && image.imageUrl.startsWith('data:image/');

                imageCard.innerHTML = `
                    <div class="image-preview">
                        ${isImageFile && (isBase64 || image.imageUrl) ?
                        `<img src="${isBase64 ? image.imageUrl : API_BASE_URL + image.imageUrl}" alt="${image.description}" style="max-width: 100%; max-height: 100%; object-fit: contain;">` :
                        `<div>üìÑ ${image.format}</div>`
                    }
                    </div>
                    <div class="image-info">
                        <div class="image-name">${image.description}</div>
                        <div class="image-details">
                            Ê†ºÂºè: ${image.format} | 
                            Â§ßÂ∞è: ${image.size ? formatFileSize(image.size) : (image.fileSize ? formatFileSize(image.fileSize) : 'Êú™Áü•')}
                        </div>
                    </div>
                `;

                imagesGrid.appendChild(imageCard);
            });
        }

        // ÊòæÁ§∫ËøõÂ∫¶Êù°
        function showProgress() {
            progressSection.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Ê≠£Âú®Â§ÑÁêÜÊñá‰ª∂...';
            uploadBtn.disabled = true;
        }

        // ÈöêËóèËøõÂ∫¶Êù°
        function hideProgress() {
            progressSection.style.display = 'none';
            uploadBtn.disabled = false;
        }

        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        // ÈöêËóèÊâÄÊúâÊ∂àÊÅØ
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Ê£ÄÊü•ÊúçÂä°Âô®ÂÅ•Â∫∑Áä∂ÊÄÅ
        async function checkServerHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (!response.ok) {
                    throw new Error('ÊúçÂä°Âô®ËøûÊé•Â§±Ë¥•');
                }
                console.log('ÊúçÂä°Âô®ËøûÊé•Ê≠£Â∏∏');
            } catch (error) {
                console.error('ÊúçÂä°Âô®ËøûÊé•Â§±Ë¥•:', error);
                showError('Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä®');
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners();
            checkServerHealth();
            // ‰∏çÂÜçÂä†ËΩΩÁé∞ÊúâÂõæÁâáÔºåÂõ†‰∏∫ÂõæÁâáÁé∞Âú®‰ª•base64Ê†ºÂºèËøîÂõû
            resultsSection.style.display = 'none';
        });
    </script>
</body>

</html>